@{
    Layout = null;
}
@model IEnumerable<Entidad.Cubo_Planilla>
@{
    ClientSettingsModel optionsModel = ViewBag.DemoSettingsModel;
    ClientSettingsModel optionsModel1 = ViewBag.DemoSettingsModel1;
}
@{
    ViewBag.Title = "Cubo de calculo de planilla - Scire 360";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>@ViewBag.Title</title>
    <!--=====================================================================================================-->
    <!-- base:css -->
    @*@Styles.Render("~/Content/template1")*@
    <link href="~/Content/bootstrap/vendors/mdi/css/materialdesignicons.min.css" rel="stylesheet" />
    <link href="~/Content/bootstrap/vendors/feather/feather.css" rel="stylesheet" />
    <link href="~/Content/bootstrap/vendors/base/vendor.bundle.base.css" rel="stylesheet" />

    <!-- endinject -->
    <!-- plugin css for this page -->
    <link href="~/Content/bootstrap/vendors/flag-icon-css/css/flag-icon.min.css" rel="stylesheet" />
    <link href="~/Content/bootstrap/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="~/Content/bootstrap/vendors/jquery-bar-rating/fontawesome-stars-o.css" rel="stylesheet">
    <link href="~/Content/bootstrap/vendors/jquery-bar-rating/fontawesome-stars.css" rel="stylesheet">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    @*@Styles.Render("~/Content/template3")*@
    <link href="~/Content/bootstrap/css/style.css" rel="stylesheet" />
    <script src="~/Content/bootstrap/vendors/base/vendor.bundle.base.js"></script>


    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    @*<script src="Content/bootstrap/vendors/base/vendor.bundle.base.js"></script>*@

    <!-- endinject -->
    <!-- Plugin js for this page-->
    <!-- End plugin js for this page-->
    <!-- inject:js -->
    <script src="~/Content/bootstrap/js/off-canvas.js"></script>
    <script src="~/Content/bootstrap/js/hoverable-collapse.js"></script>
    <script src="~/Content/bootstrap/js/template.js"></script>
    <!-- endinject -->
    <!-- plugin js for this page -->
    <script src="~/Content/bootstrap/vendors/chart.js/Chart.min.js"></script>
    <script src="~/Content/bootstrap/vendors/jquery-bar-rating/jquery.barrating.min.js"></script>
    <script src="~/Content/bootstrap/js/dashboard.js"></script>

    @Html.C1().Styles().Theme(Theme.CurrentTheme)
    @Styles.Render("~/BootStrapCss")
    @Styles.Render("~/Content/css/explorer")
    @Styles.Render("~/Content/SyntaxHighlighter/codeHighlight")

    <script src="~/Scripts/jquery.js"></script>
    @Html.C1().Scripts().Basic().Olap()
    @Scripts.Render("~/bundles/explorer")


    <script>
    </script>
    <script src="~/Scripts/ControlLayout.js"></script>
    @Scripts.Render("~/bundles/SyntaxHighlighter/codeHighlight")
    <style>
        .titleCubo {
            color: #222b45;
            font-family: Open Sans, sans-serif;
            font-weight: 600;
            font-size: 40px;
        }

        .custom.wj-flexgrid {
            border: #969595 1px solid;
            border-radius: 10px;
            margin-top: 15px;
        }

        .custom .wj-topleft .wj-cell {
            background: #B89EDE;
            color: #fff;
        }

        .custom .wj-colheaders .wj-cell {
            background: #B89EDE;
            color: #fff;
            text-align: center !important;
        }

        .custom .wj-rowheaders .wj-cell {
            background: #fff;
            color: #000;
        }

        .custom .wj-alt {
            font-style: italic;
        }

        .custom .wj-group:not(.wj-state-selected):not(.wj-state-multi-selected) {
            font-weight: bold;
            background-color: darkseagreen;
        }

        .custom .wj-glyph-down-right {
            color: green;
        }

        .custom .wj-glyph-right {
            color: green;
        }

        .custom .wj-state-selected {
            border: #B89EDE 2px solid;
        }

        .custom .wj-state-multi-selected {
            border: #B89EDE 2px solid;
        }

        .custom .wj-grid-editor {
            color: #B89EDE;
        }

        /*.custom .wj-glyph-up {
            color: blueviolet;
        }

        .custom .wj-glyph-down {
            color: blueviolet;
        }*/

        .nav-tabs .nav-link.active, .nav-tabs .nav-item.show .nav-link {
            color: #B89EDE;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }

        .nav-tabs .nav-link {
            color: #8f9bb3;
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        .nav-link {
            display: block;
            padding: 0.5rem 1rem;
        }
                        
    </style>
    
</head>
<body>
    <nav style="position: absolute !important" class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
        <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center" style="background: #ffffff">
            <a class="navbar-brand brand-logo" style="padding-top:5%" href="#">
                <img style="width: 150px; height: 100%;" src="~/Image/Scire 360.png" />
            </a>
            <a class="navbar-brand brand-logo-mini" style="padding-top:10%" href="#">
                <img style="width: 150px; height: 100%;" src="~/Image/favicon.png" />
            </a>
        </div>
    </nav>

    <div class="">
        <div class="col-lg-12 grid-margin-lg-0  grid-margin">
            <div class="card mb-0">
                <div class="card-header" style="text-align: center; background:#ffffff">
                    <h4 class="titleCubo">Cubo de calculo de planilla</h4>
                </div>

                <div class="card-body">
                    <div class="container-fluid">
                        <div class="container-fluid">
                            <div class="row">
                            </div>
                            <div class="row">
                                <h4><i><b style="color: #B89EDE">CUBO OLAP</b> | <span style="color: #187691; font-size: 12px;">Mediante esta pantalla podrá diseñar y gráficar el tipo de reporte que se desea</span></i></h4>
                            </div>
                            <br />
                        </div>
                    </div>
                    <div class="col-lg- d-none d-lg-block bg-register-image"></div>
                    <p></p>

                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link " id="home1-tab" data-toggle="tab" href="#home1" role="tab" aria-controls="home1" aria-selected="true"><b>DATOS CUBO</b></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link show active" id="home2-tab" data-toggle="tab" href="#home2" role="tab" aria-controls="home2" aria-selected="false"><b>CUBO DE DATOS </b></a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="home3-tab" data-toggle="tab" href="#home3" role="tab" aria-controls="home3" aria-selected="false"><b>GRÁFICOS</b></a>
                        </li>
                    </ul>
                    <div class="tab-content">

                        <div class="tab-pane" id="home1" role="tabpanel" aria-labelledby="home1-tab">
                            <p></p>
                            <a href="@Url.Action("Index", "CuboMaster")" class="btn btn-danger btn-sm" style="font-size:13px;font-weight:bold;float:left;">
                                VOLVER PARAMETROS
                            </a>
                            <div class="col-sm-12">
                                @(Html.C1().PivotEngine().Id("indexEngine")
        .ShowRowTotals(ShowTotals.GrandTotals)
        .ShowColumnTotals(ShowTotals.Subtotals)
        .TotalsBeforeData(false)
        .SortableGroups(true)
        .Bind(Model)
        .RowFields(pfcb => pfcb.Items("TRABAJADOR"))
        .ColumnFields(cfcb => cfcb.Items("COLUMNA"))
        .ColumnFields(cfcb => cfcb.Items("CONCEPTO"))
        .ValueFields(vfcb => vfcb.Items("VALOR"))
        .ShowZeros(true)
                                    )
                                <div class="col-sm-12  col-md-12">
                                    @Html.C1().PivotPanel().Id(optionsModel.ControlId).ItemsSourceId("indexEngine").CssStyle("font-size", "11px")
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane active" id="home2" role="tabpanel" aria-labelledby="home2-tab" aria-selected="true">
                            <div id="divNotification">

                            </div>
                            <div class="col-sm-12">
                                <p></p>
                                <div class="col-sm-12 col-md-12" style="text-align:right">
                                    <!--<button type="button" class="btn btn-success" style="font-size:13px;font-weight:bold; float:right; width:15%" onclick="loadView()">
                                            CARGAR VISTA
                                        </button>-->
                                    @if (@Session["disenoCuboId"].ToString() != "0")
                                    {
                                    <button type="button" class="btn btn-info" style="font-size:13px;font-weight:bold; float:right; width:15%; margin-left: 10px" id="btnGuardar">
                                        GUARDAR VISTA
                                    </button>
                                    }
                                    <button type="button" class="btn btn-success" style="font-size:13px;font-weight:bold; float:right; width:15%" onclick="excelExport()">
                                        EXPORTAR EXCEL
                                    </button>
                                </div>
                                <div class="table-responsive" style="text-align:center">
                                    <div class="col-sm-12 col-md-12">
                                        @(Html.C1().PivotGrid().Id("indexGrid").CssClass("custom")
                                            .ItemsSourceId("indexEngine")
                                            .OutlineMode(false)
                                            .ShowValueFieldHeaders(true).CssStyle("font-size", "18px")
                                            )
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="home3" role="tabpanel" aria-labelledby="home3-tab">
                            <br />
                            <p></p>
                            <div class="table-responsive">
                                @if (@Session["ddl_grafico"].ToString() == "1")
                                {
                                    @Html.C1().PivotChart().Id(optionsModel1.ControlId).ItemsSourceId("indexEngine").CssStyle("font-size", "8px").CssStyle("text-transform", "uppercase").ShowTitle(true).ChartType(PivotChartType.Column)
                                }
                                @if (@Session["ddl_grafico"].ToString() == "2")
                                {
                                    @Html.C1().PivotChart().Id(optionsModel1.ControlId).ItemsSourceId("indexEngine").CssStyle("font-size", "8px").CssStyle("text-transform", "uppercase").ShowTitle(true).ChartType(PivotChartType.Area)

                                }
                                @if (@Session["ddl_grafico"].ToString() == "3")
                                {
                                    @Html.C1().PivotChart().Id(optionsModel1.ControlId).ItemsSourceId("indexEngine").CssStyle("font-size", "8px").CssStyle("text-transform", "uppercase").ShowTitle(true).ChartType(PivotChartType.Bar)
                                }
                                @if (@Session["ddl_grafico"].ToString() == "4")
                                {
                                    @Html.C1().PivotChart().Id(optionsModel1.ControlId).ItemsSourceId("indexEngine").CssStyle("font-size", "8px").CssStyle("text-transform", "uppercase").ShowTitle(true).ChartType(PivotChartType.Line)
                                }
                                @if (@Session["ddl_grafico"].ToString() == "5")
                                {
                                    @Html.C1().PivotChart().Id(optionsModel1.ControlId).ItemsSourceId("indexEngine").CssStyle("font-size", "8px").CssStyle("text-transform", "uppercase").ShowTitle(true).ChartType(PivotChartType.Pie)
                                }
                                @if (@Session["ddl_grafico"].ToString() == "6")
                                {
                                    @Html.C1().PivotChart().Id(optionsModel1.ControlId).ItemsSourceId("indexEngine").CssStyle("font-size", "8px").CssStyle("text-transform", "uppercase").ShowTitle(true).ChartType(PivotChartType.Scatter)
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
    <script type="text/javascript">
        window.onload = function () {
            if ("@Session["disenoCubo"].ToString()" != "" && "@Session["disenoCuboId"].ToString()" != "0") {
                loadView();
            }
        };
        c1.documentReady(function () {
            var engine = c1.getService('indexEngine');
            var field = engine.fields.getField("VALOR");
            var field2 = engine.fields.getField("BASICO");
            field.format = "n2";
            field2.format = "n2";
        })
        function saveView() {
            var ng = c1.getService('indexEngine');
            if (ng && ng.isViewDefined) {
                saveCubo(ng.viewDefinition);
                //localStorage.viewDefinition = ng.viewDefinition;
            }
        }
        function saveCubo(diseno) {
            try {
                let datos = {
                    Diseno: diseno
                };

                $.post("SaveCubo", datos).done(function (e) {
                    console.log(e);
                    if (e.result === 1) {
                        $("#divNotification").html("<div class=\"alert alert-success\" role=\"alert\"><small><b>Operación exitosa</b></small></div>");
                        $("#divNotification").fadeTo(5000, 500).slideUp(500, function () {
                            $("#divNotification").slideUp(500);
                        });
                    }
                    else {
                        $("#divNotification").html("<div class=\"alert alert-warning\" role=\"alert\"><small><b>" + e.message + "</b></small></div>");
                        $("#divNotification").fadeTo(5000, 500).slideUp(500, function () {
                            $("#divNotification").slideUp(500);
                        });
                    }
                });
            } catch (e) {
                throw e;
            }

            // search();
        }
        $("#btnGuardar").on('click', function () {
            saveView();
        });
        function loadView() {
            var ng = c1.getService('indexEngine');
            if (ng) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("getView", "Cubo")',
                    data: '{}',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (success) {
                        ng.viewDefinition = success;
                        var cmbRowTotals = wijmo.Control.getControl('#RowTotals');
                        if (cmbRowTotals) {
                            cmbRowTotals.selectedValue = ng.showRowTotals;
                        }

                        var cmbColTotals = wijmo.Control.getControl('#ColTotals');
                        if (cmbColTotals) {
                            cmbColTotals.selectedValue = ng.showColumnTotals;
                        }

                        var chkShowZeros = document.getElementById('ColTotals');
                        if (chkShowZeros) {
                            chkShowZeros.checked = ng.showZeros;
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                            console.log(textStatus);
                    }
                });
            }
        }

        function excelExport() {
            var pivotGrid = wijmo.Control.getControl('#indexGrid');

            // create book with current view
            var book = wijmo.grid.xlsx.FlexGridXlsxConverter.save(pivotGrid, {
                includeColumnHeaders: true,
                includeRowHeaders: true
            });
            book.sheets[0].name = 'CUBO PLANILLA';
            addTitleCell(book.sheets[0], getViewTitle(pivotGrid.engine));

            // add sheet with transposed view
            transposeView(pivotGrid.engine);
            var transposed = wijmo.grid.xlsx.FlexGridXlsxConverter.save(pivotGrid, {
                includeColumnHeaders: true,
                includeRowHeaders: true
            });
            transposed.sheets[0].name = 'CUBO PLANILLA VERTICAL';
            addTitleCell(transposed.sheets[0], getViewTitle(pivotGrid.engine));
            book.sheets.push(transposed.sheets[0]);
            transposeView(pivotGrid.engine);
            var f = new Date();
            // save the book
            book.save('CUBO_PLANILLA.OLAP.' + f.getDate() + "" + (f.getMonth() + 1) + "" + f.getFullYear() + '.xlsx');
        }

        // build a title for the current view
        function getViewTitle(ng) {
            var title = '';
            for (var i = 0; i < ng.valueFields.length; i++) {
                if (i > 0) title += ', ';
                title += ng.valueFields[i].header;
            }
            title += ' POR ';
            if (ng.rowFields.length) {
                for (var i = 0; i < ng.rowFields.length; i++) {
                    if (i > 0) title += ', ';
                    title += ng.rowFields[i].header;
                }
            }
            if (ng.rowFields.length && ng.columnFields.length) {
                title += ' Y POR ';
            }
            if (ng.columnFields.length) {
                for (var i = 0; i < ng.columnFields.length; i++) {
                    if (i > 0) title += ', ';
                    title += ng.columnFields[i].header;
                }
            }
            return title;
        }

        function transposeView(ng) {
            ng.deferUpdate(function () {

                // save row/col fields
                var rows = [],
                    cols = [];
                for (var r = 0; r < ng.rowFields.length; r++) {
                    rows.push(ng.rowFields[r].header);
                }
                for (var c = 0; c < ng.columnFields.length; c++) {
                    cols.push(ng.columnFields[c].header);
                }

                // clear row/col fields
                ng.rowFields.clear();
                ng.columnFields.clear();

                // restore row/col fields in transposed order
                for (var r = 0; r < rows.length; r++) {
                    ng.columnFields.push(rows[r]);
                }
                for (var c = 0; c < cols.length; c++) {
                    ng.rowFields.push(cols[c]);
                }
            });
        }

        // adds a title cell into an xlxs sheet
        function addTitleCell(sheet, title) {

            // create cell
            var cell = new wijmo.xlsx.WorkbookCell();
            cell.value = title;
            cell.style = new wijmo.xlsx.WorkbookStyle();
            cell.style.font = new wijmo.xlsx.WorkbookFont();
            cell.style.font.bold = true;

            // create row to hold the cell
            var row = new wijmo.xlsx.WorkbookRow();
            row.cells[0] = cell;

            // and add the new row to the sheet
            sheet.rows.splice(0, 0, row);
        }

        // toggle outline mode
        function toggleOulineMode(e) {
            var pivotGrid = wijmo.Control.getControl('#indexGrid');
            pivotGrid.outlineMode = e.target.checked;
        }
        // toggle ShowValueFieldHeaders
        function toggleShowValueFieldHeaders(e) {
            var pivotGrid = wijmo.Control.getControl('#indexGrid');
            pivotGrid.showValueFieldHeaders = e.target.checked;
        }
    </script>
</body>
</html>